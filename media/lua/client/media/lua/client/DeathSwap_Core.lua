--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

require "lua_timers"
DeathSwap = DeathSwap or {}

function DeathSwap.shuffle(tbl)
    local shuffled = {}
    for i, v in ipairs(tbl) do
        shuffled[i] = v
    end
    for i = #shuffled, 2, -1 do
        local j = ZombRand(i) + 1
        shuffled[i], shuffled[j] = shuffled[j], shuffled[i]
    end
    return shuffled
end

function DeathSwap.prepDeathSwap(user, targ)
    sendClientCommand('DeathSwap', 'doDeathSwap', {
        targName = targ.user,
        user = user.user,
        x = targ.x,
        y = targ.y,
        z = targ.z,
    })
end

function DeathSwap.getRandJoke(int)
    local randJoke = {
        [1] = getText("IGUI_deathswap_joke1") or "YOU ARE ATTEMPTING TO DO THE IMPOSSIBLE!",
        [2] = getText("IGUI_deathswap_joke2") or "YOU TELEPORTED TO YOUR OWN POSITION!",
        [3] = getText("IGUI_deathswap_joke3") or "YOU HAVE NO FRIENDS!",
        [4] = getText("IGUI_deathswap_joke4") or "NOT ENOUGH PLAYERS TO TELEPORT!",
    }
    return randJoke[int] or randJoke[1]
end

function DeathSwap.playSfx(pl)
    local shouldPlaySfx = SandboxVars.DeathSwap.playSfx or true
    if shouldPlaySfx then
        pl = pl or getPlayer()
        pl:playSoundLocal("TrapTimerExpired")
        timer:Simple(2, function()
            pl:playSoundLocal("HitBarricadeMetal")
        end)
    end
end

function DeathSwap.triggerDeathSwap(deathSwapTable)
    DeathSwap.playSfx(getPlayer())
    SendCommandToServer('/servermsg "Death Swap!"')

    if #deathSwapTable % 2 == 0 then
        for i = 1, #deathSwapTable, 2 do
            DeathSwap.prepDeathSwap(deathSwapTable[i], deathSwapTable[i + 1])
            DeathSwap.prepDeathSwap(deathSwapTable[i + 1], deathSwapTable[i])
        end
    else
        for i = 1, #deathSwapTable do
            local target = deathSwapTable[(i % #deathSwapTable) + 1]
            DeathSwap.prepDeathSwap(deathSwapTable[i], target)
        end
    end
end

function DeathSwap.doDeathSwap(counter) -- /ds 0 to 60
    local olPl = getOnlinePlayers()
    local deathSwapTable = {}

    for i = 0, olPl:size() - 1 do
        local user = olPl:get(i):getUsername()
        if user and not DeathSwap.isBlacklisted(user) then
            local targ = getPlayerFromUsername(user)
            if targ then
                table.insert(deathSwapTable, {
                    user = user,
                    x = math.floor(targ:getX() + 0.5),
                    y = math.floor(targ:getY() + 0.5),
                    z = targ:getZ()
                })
            end
        end
    end

    if #deathSwapTable < 2 then
        local joke = DeathSwap.getRandJoke(ZombRand(1, 4))
        print(joke)
        HaloTextHelper.addTextWithArrow(getPlayer(), joke, false, 255, 0, 0)
        return
    else
        local str = getText("IGUI_deathswap_start") or "Death Swap will soon begin in"
        SendCommandToServer(string.format('/servermsg "%s"', str))

        Events.OnTick.Add(function()
            if counter == nil then
                counter = math.max(0, math.min(60, tonumber(counter) or 10))
            end
            local countdownStart = counter or SandboxVars.DeathSwap.Countdown

            deathSwapTable = DeathSwap.shuffle(deathSwapTable)

            if countdownStart == 0 then
                DeathSwap.triggerDeathSwap(deathSwapTable)
            else
                local countdownTimestamp = getTimestampMs()
                local function countdown()
                    local currentTimestamp = getTimestampMs()
                    local elapsedTimeSec = math.floor((currentTimestamp - countdownTimestamp) / 1000)
                    local remainingTime = countdownStart - elapsedTimeSec
                    if remainingTime > 0 then
                        SendCommandToServer(string.format('/servermsg "%s"', remainingTime))
                    else
                        DeathSwap.triggerDeathSwap(deathSwapTable)
                        Events.OnTick.Remove(countdown)
                    end
                end
                Events.OnTick.Add(countdown)
            end
        end)
    end
end
