--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

require "lua_timers"
DeathSwap = DeathSwap or {}



function DeathSwap.getRandJoke(int)
    local randJoke = {
        [1] = getText("IGUI_deathswap_joke1") or "YOU ARE ATTEMPTING TO DO THE IMPOSSIBLE!",
        [2] = getText("IGUI_deathswap_joke2") or "YOU TELEPORTED TO YOUR OWN POSITION!",
        [3] = getText("IGUI_deathswap_joke3") or "YOU HAVE NO FRIENDS!",
        [4] = getText("IGUI_deathswap_joke4") or "NOT ENOUGH PLAYERS TO TELEPORT!"
    }
    return randJoke[int] or randJoke[1]
end


function DeathSwap.playSfx(pl)
    local shouldPlaySfx = SandboxVars.DeathSwap.playSfx or true
    if shouldPlaySfx then
        pl = pl or getPlayer()
        pl:playSoundLocal("TrapTimerExpired")
        timer:Simple(2, function()
            pl:playSoundLocal("HitBarricadeMetal")
        end)
    end
end



-----------------------            ---------------------------

function DeathSwap.getParticipantsData()
    local olPl = getOnlinePlayers()
    local participants = {}

    for i = 0, olPl:size() - 1 do
        local user = olPl:get(i):getUsername()
        if user and not DeathSwap.isBlacklisted(user) then
            local targ = getPlayerFromUsername(user)
            if targ then
                table.insert(participants, {
                    username = user,
                    x = round(targ:getX()),
                    y = round(targ:getY()),
                    z = targ:getZ()
                })
                if (getCore():getDebug() and isAdmin()) then
                    print(user)
                end
            end
        end
    end

    if #participants < 2 then
        local joke = DeathSwap.getRandJoke(ZombRand(1, 5))
        HaloTextHelper.addTextWithArrow(getPlayer(), joke, false, 255, 0, 0)
        return nil
    end

    return participants
end

function DeathSwap.doShuffle(tab)
    if not tab then return end
    local function hasSameIndices(indices)
        for i, v in ipairs(indices) do
            if i == v then
                return true
            end
        end
        return false
    end

    local n = #tab
    local indices = {}

    for i = 1, n do
        indices[i] = i
    end

    repeat
        for i = n, 2, -1 do
            local j = ZombRand(i) + 1
            indices[i], indices[j] = indices[j], indices[i]
        end
    until not hasSameIndices(indices)

    local shuffledTab = {}
    for i = 1, n do
        shuffledTab[i] = {
            username = tab[i].username,
            x = tab[indices[i]].x,
            y = tab[indices[i]].y,
            z = tab[indices[i]].z
        }
    end

    return shuffledTab
end

function DeathSwap.getTimeStamp()
    local dateTable = os.date("*t")
    local timestamp = string.format("%04d%02d%02d%02d%02d%02d",
        dateTable.year, dateTable.month, dateTable.day,
        dateTable.hour, dateTable.min, dateTable.sec)
    return timestamp
end

function DeathSwap.doDeathSwap()
    local pl = getPlayer()
    if not pl then return end

    local user = pl:getUsername()
    local timestamp = DeathSwap.getTimeStamp()
    local msg = "Death Swap Command: "
    if pl:isAccessLevel("admin") then
        local participantsData = DeathSwap.getParticipantsData()

        if participantsData then
            local shuffledData = DeathSwap.doShuffle(participantsData)
            if shuffledData then
                DeathSwap.sendDeathSwap(shuffledData)
            end
            msg = msg ..user .. " Triggered Death Swap " .. timestamp
        else
            msg =  msg .. user .. " Tried to Trigger Death Swap and failed " .. timestamp
        end
    else
        msg = msg .. "Non-admin user " .. user .. " tried to trigger Death Swap and failed " .. timestamp
    end

    ISLogSystem.writeLog(pl, msg)
    ISLogSystem.sendLog(pl, "DeathSwap", msg)
end


function DeathSwap.sendDeathSwap(shuffledData)
    local pkt = {}
    if shuffledData then
        for _, p in ipairs(shuffledData) do
            table.insert(pkt, {
                username = p.username,
                x = p.x,
                y = p.y,
                z = p.z
            })
        end
    end
    if isClient() then
        sendClientCommand("DeathSwap", "doDeathSwap", {pkt = pkt})
    end
end

-----------------------            ---------------------------